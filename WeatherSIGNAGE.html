<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>川崎市 時刻・天気</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #111111; /* 暗い背景 */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            overflow: hidden; /* スクロールバーを隠す */
        }

        .signage-container {
            width: 100%;
            height: 100%;
            background-color: #222222; /* 電子ペーパーの背景に近い暗い色 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 20px rgba(255,255,255,0.1); /* 明るい影 */
            border: 10px solid #555555; /* やや明るいグレーのフレーム */
            box-sizing: border-box;
            position: relative; /* アスペクト比維持のため */
        }

        /* 16:9 アスペクト比を維持するラッパー */
        .aspect-ratio-wrapper {
            width: 95vw; /* ビューポート幅の95% */
            max-width: calc(95vh * 16 / 9); /* 高さを基準にした最大幅 (16:9) */
            height: calc(95vw * 9 / 16); /* 幅を基準にした高さ (16:9) */
            max-height: 95vh; /* ビューポート高さの95% */
            position: relative;
        }


        .content-grid {
            display: grid;
            grid-template-rows: auto 1fr; /* 上段(時刻)はコンテンツに合わせ、下段(天気)は残りのスペースを占有 */
            width: 100%;
            height: 100%;
            padding: 3vmin; /* 全体のパディングを少し調整 */
            gap: 3vmin; /* 全体のギャップを少し調整 */
            box-sizing: border-box;
        }

        .time-section, .weather-section {
            background-color: #333333; /* やや明るいグレーのパネル背景 */
            border: 2px solid #666666; /* 中間グレーのボーダー */
            border-radius: 8px;
            padding: 2vmin;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #dddddd;
        }

        .time-section {
            grid-row: 1 / 2;
            padding: 3vmin; /* 時刻セクションのパディング */
        }

        .weather-section {
            grid-row: 2 / 3;
            display: grid;
            /* grid-template-columns: 0.8fr 1.2fr; アイコン側を少し狭く、詳細側を少し広く */
            /* 横表示ではアイコンと詳細を左右に均等に近づけるか、アイコンを少し小さめにする */
            grid-template-columns: 0.7fr 1.3fr; /* アイコンを少し小さめに、詳細を広めに */
            align-items: center;
            gap: 2vmin; /* アイコンと詳細の間のギャップ */
        }

        #time {
            font-family: 'Roboto Mono', monospace;
            font-size: 15vmin; /* 横長画面に合わせて調整 */
            font-weight: 700;
            line-height: 1;
            color: #eeeeee;
        }

        #date {
            font-size: 5vmin; /* 横長画面に合わせて調整 */
            margin-top: 1vmin;
            color: #cccccc;
        }

        .weather-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        #weather-icon {
            width: auto;
            height: auto;
            max-width: 25vmin; /* アイコンコンテナの最大サイズ (横表示用) */
            max-height: 25vmin;
            // background-color: #dddddd; /* アイコン背景 */
            border-radius: 8px;
            padding: 1.5vmin; /* アイコンと背景の間のパディング */
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
            margin:0 -100px 0  0;
        }
        #weather-icon .material-symbols-outlined {
            font-size: 28vmin; /* アイコン自体のサイズ (横表示用) */
            color: #ffffffff; /* アイコンの色 (背景が明るいため暗く) */
            font-variation-settings:
                'FILL' 0,
                'wght' 300,
                'GRAD' 0,
                'opsz' 48;
        }


        .weather-details {
            font-size: 3.8vmin; /* 天気詳細の基準フォントサイズ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; /* 詳細部分は中央揃え */
            gap: 0.5vmin;
            height: 100%;
            text-align: center;
            width: 100%;
        }

        #temperature {
            font-size: 16vmin; /* 温度表示のサイズ (横表示用) */
            font-weight: 700;
            color: #eeeeee;
            line-height: 1.1;
        }
        #weather-description {
            font-size: 3.8vmin; /* 天気説明のサイズ */
            color: #cccccc;
            line-height: 1.3;
            padding: 0 1vmin;
        }
        #city-name {
            font-size: 3.3vmin; /* 都市名のサイズ */
            color: #bbbbbb;
            margin-top: 0.5vmin;
        }

        /* ローディング・エラーメッセージ */
        .message {
            font-size: 3.5vmin; /* メッセージのフォントサイズ調整 */
            color: #bbbbbb;
        }

    </style>
</head>
<body>
    <div class="aspect-ratio-wrapper">
        <div class="signage-container">
            <div class="content-grid">
                <div class="time-section">
                    <div id="time" class="font-roboto-mono">--:--:--</div>
                    <div id="date" class="font-noto">----年--月--日 (-)</div>
                </div>
                <div class="weather-section">
                    <div class="weather-icon-container">
                        <div id="weather-icon">
                            <span class="material-symbols-outlined">help</span>
                        </div>
                    </div>
                    <div class="weather-details">
                        <div id="temperature" class="font-roboto-mono">--°C</div>
                        <div id="weather-description" class="font-noto">読み込み中...</div>
                        <div id="city-name" class="font-noto">川崎市</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 川崎市の緯度経度 (例: 川崎市役所周辺)
        const latitude = 35.5300;
        const longitude = 139.7036;

        const timeElement = document.getElementById('time');
        const dateElement = document.getElementById('date');
        const weatherIconElement = document.getElementById('weather-icon'); // div containing the span
        const temperatureElement = document.getElementById('temperature');
        const weatherDescriptionElement = document.getElementById('weather-description');
        const cityNameElement = document.getElementById('city-name');

        let todayWeatherData = null;
        let tomorrowWeatherData = null;
        let isDisplayingToday = true; // 最初は今日の天気を表示
        let weatherIntervalId = null; // 天気情報更新用インターバルID
        let displayToggleIntervalId = null; // 表示切替用インターバルID

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            timeElement.textContent = `${hours}:${minutes}:${seconds}`;

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][now.getDay()];
            dateElement.textContent = `${year}年${month}月${day}日 (${dayOfWeek})`;
        }

        // WMO天候コードから日本語の説明とMaterial Symbolアイコン名を取得
        function getWeatherInfoFromWMOCode(code) {
            const wmoMap = {
                0: { description: "快晴", icon: "sunny" },
                1: { description: "ほぼ快晴", icon: "partly_cloudy_day" },
                2: { description: "所により曇り", icon: "partly_cloudy_day" },
                3: { description: "曇り", icon: "cloud" },
                45: { description: "霧", icon: "foggy" },
                48: { description: "霧氷", icon: "ac_unit" },
                51: { description: "霧雨 (弱)", icon: "rainy_light" },
                53: { description: "霧雨", icon: "rainy_light" },
                55: { description: "霧雨 (強)", icon: "rainy_light" },
                56: { description: "着氷性の霧雨", icon: "sleet" },
                57: { description: "着氷性の霧雨", icon: "sleet" },
                61: { description: "雨 (弱)", icon: "rainy" },
                63: { description: "雨", icon: "rainy" },
                65: { description: "雨 (強)", icon: "rainy_heavy" },
                66: { description: "着氷性の雨", icon: "sleet" },
                67: { description: "着氷性の雨", icon: "sleet" },
                71: { description: "雪 (弱)", icon: "weather_snowy" },
                73: { description: "雪", icon: "weather_snowy" },
                75: { description: "雪 (強)", icon: "weather_snowy" },
                77: { description: "霧雪", icon: "grain" },
                80: { description: "にわか雨 (弱)", icon: "rainy_light" },
                81: { description: "にわか雨", icon: "rainy" },
                82: { description: "にわか雨 (強)", icon: "thunderstorm" },
                85: { description: "にわか雪 (弱)", icon: "weather_snowy" },
                86: { description: "にわか雪 (強)", icon: "weather_snowy" },
                95: { description: "雷雨", icon: "thunderstorm" },
                96: { description: "雷雨 (雹)", icon: "thunderstorm" },
                99: { description: "雷雨 (雹)", icon: "thunderstorm" },
            };
            return wmoMap[code] || { description: `コード:${code}`, icon: "help" };
        }

        function updateWeatherDisplay() {
            let displayData;
            let dayLabel = "";
            let tempString = "--°C";
            let descriptionText = "情報なし";
            let iconName = "help";

            if (isDisplayingToday && todayWeatherData) {
                displayData = todayWeatherData;
                dayLabel = "今日";
                tempString = `${displayData.temperature}°C`; // 現在の気温
                const weatherInfo = getWeatherInfoFromWMOCode(displayData.weathercode);
                iconName = weatherInfo.icon;
                descriptionText = `${dayLabel}: ${weatherInfo.description}`;
                if (displayData.max_temp !== null && displayData.min_temp !== null) {
                    descriptionText += ` (最高 ${displayData.max_temp}°C / 最低 ${displayData.min_temp}°C)`;
                }


            } else if (!isDisplayingToday && tomorrowWeatherData) {
                displayData = tomorrowWeatherData;
                dayLabel = "明日";
                tempString = displayData.max_temp !== null ? `${displayData.max_temp}°C` : '--°C'; // 明日は最高気温をメイン表示
                const weatherInfo = getWeatherInfoFromWMOCode(displayData.weathercode);
                iconName = weatherInfo.icon;
                descriptionText = `${dayLabel}: ${weatherInfo.description}`;
                if (displayData.max_temp !== null && displayData.min_temp !== null) {
                    descriptionText += ` (最高 ${displayData.max_temp}°C / 最低 ${displayData.min_temp}°C)`;
                }

            } else {
                // データがない場合
                descriptionText = "読込中..."; // 初期メッセージ
                weatherDescriptionElement.classList.add('message');
            }

            weatherIconElement.innerHTML = `<span class="material-symbols-outlined">${iconName}</span>`;
            temperatureElement.textContent = tempString;
            weatherDescriptionElement.textContent = descriptionText;

            if (descriptionText !== "情報なし" && descriptionText !== "読込中..." && !descriptionText.startsWith("APIエラー") && !descriptionText.startsWith("天気情報取得エラー") && !descriptionText.startsWith("天気データ形式エラー")) {
                 weatherDescriptionElement.classList.remove('message');
            } else {
                 weatherDescriptionElement.classList.add('message');
            }
            cityNameElement.textContent = '川崎市';
        }

        async function fetchWeather() {
            // Open-Meteo API: 現在の天気と2日間の日次予報を取得
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia/Tokyo&forecast_days=2`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    let errorText = `APIエラー: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.reason) {
                           errorText = `APIエラー: ${errorData.reason}`;
                        }
                    } catch (e) { /* JSONパース失敗 */ }
                    throw new Error(errorText);
                }
                const data = await response.json();

                if (data && data.current_weather && data.daily && data.daily.time && data.daily.time.length >= 2) {
                    // 今日の天気データ
                    todayWeatherData = {
                        temperature: Math.round(data.current_weather.temperature),
                        weathercode: data.current_weather.weathercode,
                        max_temp: data.daily.temperature_2m_max[0] !== null ? Math.round(data.daily.temperature_2m_max[0]) : null,
                        min_temp: data.daily.temperature_2m_min[0] !== null ? Math.round(data.daily.temperature_2m_min[0]) : null,
                    };

                    // 明日の天気データ
                    tomorrowWeatherData = {
                        weathercode: data.daily.weathercode[1],
                        max_temp: data.daily.temperature_2m_max[1] !== null ? Math.round(data.daily.temperature_2m_max[1]) : null,
                        min_temp: data.daily.temperature_2m_min[1] !== null ? Math.round(data.daily.temperature_2m_min[1]) : null,
                    };

                    // 初回表示更新
                    if (!displayToggleIntervalId) { // タイマーがまだ開始されていなければ
                        updateWeatherDisplay(); // 先に一度表示を更新
                        displayToggleIntervalId = setInterval(() => {
                            isDisplayingToday = !isDisplayingToday;
                            updateWeatherDisplay();
                        }, 10000); // 10秒ごとに切り替え
                    } else {
                        // タイマーが既に動いている場合は、現在の表示を更新するだけで良い
                        updateWeatherDisplay();
                    }
                    weatherDescriptionElement.classList.remove('message');


                } else {
                    console.warn('APIは200 OKを返しましたが、期待する天気データ形式ではありませんでした。レスポンス:', JSON.stringify(data, null, 2));
                    todayWeatherData = null;
                    tomorrowWeatherData = null;
                    weatherDescriptionElement.textContent = '天気データ形式エラー';
                    weatherDescriptionElement.classList.add('message');
                    temperatureElement.textContent = '--°C';
                    weatherIconElement.innerHTML = `<span class="material-symbols-outlined">warning</span>`;
                     if (displayToggleIntervalId) {
                        clearInterval(displayToggleIntervalId);
                        displayToggleIntervalId = null; // データ不備ならタイマーも止める
                     }
                }

            } catch (error) {
                console.error('天気情報の取得に失敗しました:', error);
                todayWeatherData = null;
                tomorrowWeatherData = null;
                weatherDescriptionElement.textContent = error.message && error.message.includes('APIエラー') ? error.message : '天気情報取得エラー';
                weatherDescriptionElement.classList.add('message');
                temperatureElement.textContent = '--°C';
                weatherIconElement.innerHTML = `<span class="material-symbols-outlined">error</span>`;
                if (displayToggleIntervalId) {
                    clearInterval(displayToggleIntervalId);
                    displayToggleIntervalId = null; // エラーならタイマーも止める
                }
            }
        }

        // 初期表示
        updateTime();
        fetchWeather(); // 初回天気情報取得

        // 1秒ごとに時刻を更新
        setInterval(updateTime, 1000);
        // 15分ごとに天気情報を再取得
        if (weatherIntervalId) clearInterval(weatherIntervalId);
        weatherIntervalId = setInterval(fetchWeather, 15 * 60 * 1000);


        // ウィンドウリサイズ時にアスペクト比を再計算
        function maintainAspectRatio() {
            const wrapper = document.querySelector('.aspect-ratio-wrapper');
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            let newWidth, newHeight;
            const targetWidth = viewportWidth * 0.95;
            const targetHeight = viewportHeight * 0.95;

            // 16:9 アスペクト比をターゲット
            if (targetWidth / targetHeight > 16 / 9) { // ビューポートがターゲットより横長の場合 (高さ基準)
                newHeight = targetHeight;
                newWidth = newHeight * 16 / 9;
            } else { // ビューポートがターゲットより縦長または等しい場合 (幅基準)
                newWidth = targetWidth;
                newHeight = newWidth * 9 / 16;
            }
            wrapper.style.width = `${newWidth}px`;
            wrapper.style.height = `${newHeight}px`;
        }

        window.addEventListener('resize', maintainAspectRatio);
        maintainAspectRatio(); // 初期ロード時にも実行
    </script>
</body>
</html>
