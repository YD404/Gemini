<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>川崎市 時刻・天気</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&family=Orbitron:wght@400;700&display=swap');

        :root {
            --bg-color: #0A0A0A;
            --panel-bg-color: #1C1C1C;
            --border-color: #444444;
            --text-color-primary: #E0E0E0;
            --text-color-secondary: #A0A0A0;
            --text-color-accent: #FFFFFF;
            --line-color: #333333;
            --font-primary: 'Noto Sans JP', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
            --font-display: 'Orbitron', sans-serif;
            --animation-duration: 0.4s; 
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .signage-container {
            width: 100%;
            height: 100%;
            background-color: var(--panel-bg-color);
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center;
            border: 2px solid var(--border-color);
            box-sizing: border-box;
            position: relative;
            padding: 1.5vmin;
        }

        .aspect-ratio-wrapper {
            width: 100%; 
            height: 100%;
            position: relative;
            display: flex; 
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .content-area { 
            display: flex;
            flex-direction: column; 
            width: 100%;
            height: 100%; 
            box-sizing: border-box;
            padding-top: 6vmin; 
            padding-bottom: 6vmin; 
        }
        
        .signage-header, .signage-footer {
            width: calc(100% - 3vmin); 
            padding: 1vmin 1.5vmin;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
            font-size: 2vmin;
            color: var(--text-color-secondary);
            position: absolute;
            left: 1.5vmin;
            right: 1.5vmin;
            box-sizing: border-box;
            z-index: 10; 
            height: 6vmin; 
        }
        .signage-header {
            top: 1.5vmin;
            border-bottom: 1px solid var(--line-color);
        }
        .signage-footer {
            bottom: 1.5vmin;
            border-top: 1px solid var(--line-color);
        }
        .status-text-left { text-align: left; }
        .status-text-right { text-align: right; }

        

        .time-section {
            background-color: transparent; 
            border: 1px solid var(--line-color);
            border-radius: 0; 
            padding: 2vmin;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--text-color-primary);
            margin-bottom: 2vmin; 
            width: 100%; 
        }

        .weather-section {
            background-color: transparent;
            border: 1px solid var(--line-color);
            border-radius: 0;
            padding: 1.5vmin;
            box-sizing: border-box;
            display: flex; 
            flex-direction: row; 
            align-items: stretch; 
            text-align: center;
            color: var(--text-color-primary);
            width: 100%; 
            overflow: hidden;
        }

        #time {
            font-family: var(--font-mono);
            font-size: 14vmin; 
            font-weight: 500;
            line-height: 1;
            color: var(--text-color-accent);
            letter-spacing: -0.05em; 
        }

        #date-container { 
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            margin-top: 0.5vmin; 
            min-height: auto; 
            width: 100%; 
            height: 7vh; 
            transition: opacity var(--animation-duration) ease-in-out;
            opacity: 1;
        }
        
        #date { 
            font-family: var(--font-mono);
            color: var(--text-color-secondary);
            padding: 0 0.5vmin; 
            line-height: 1.2; 
            font-weight: 800; 
            width: 100%; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        #attribution-text { 
            font-family: var(--font-mono);
            font-size: 1.5vmin; 
            color: #666; 
            margin-top: 0.5vmin;
            letter-spacing: 0.05em;
        }


        .weather-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 0.4; 
            border-right: 1px solid var(--line-color); 
            padding-right: 1.5vmin;
            transition: opacity var(--animation-duration) ease-in-out; /* フェードアニメーション */
            opacity: 1; /* 初期状態 */
        }
        
        #weather-icon {
            width: auto;
            height: auto;
            max-width: 20vmin; 
            max-height: 20vmin;
            border-radius: 8px;
            padding: 1.5vmin;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0; 
        }
        #weather-icon .material-symbols-outlined {
            font-size: 40vmin; 
            color: #ffffffff; 
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 48; 
        }

        .weather-details {
            flex: 0.6; 
            display: flex; 
            justify-content: center;
            align-items: center;
            position: relative; 
            padding-left: 1.5vmin;
            width: 100%; 
            height: 100%; 
            transition: opacity var(--animation-duration) ease-in-out; /* フェードアニメーション */
            opacity: 1; /* 初期状態 */
        }
        
        #weather-info-display, #graph-display-wrapper, #rss-feed-display { 
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start; 
            text-align: left; 
        }
        #rss-feed-display {
            padding: 1vmin;
            overflow-y: auto; 
        }
        .rss-title {
            font-family: var(--font-primary);
            font-size: 6.0vmin;
            font-weight: 500;
            color: var(--text-color-primary);
            margin-bottom: 1vmin;
            width: 100%;
        }
        .rss-description {
            font-family: var(--font-primary);
            font-size: 3.0vmin;
            color: var(--text-color-secondary);
            line-height: 1.4;
            width: 100%;
            max-height: 60%; 
            overflow: hidden;
            margin-bottom: 0.5vmin;
        }
        .rss-author {
            font-family: var(--font-mono);
            font-size: 2.0vmin;
            color: #888;
            margin-top: 0.5vmin;
            width: 100%;
            text-align: right; 
        }


        #temperature {
            font-family: var(--font-mono);
            font-size: 25vmin; 
            font-weight: 500; 
            color: var(--text-color-accent);
            line-height: 1;
            text-align: center; 
            width: 100%;
        }
        #weather-description {
            font-family: var(--font-primary);
            font-size: 4.0vmin; 
            color: var(--text-color-secondary);
            line-height: 1.2;
            padding: 0 0.5vmin;
            font-weight: 300; 
            text-align: center;
            width: 100%;
        }
        #city-name {
            font-family: var(--font-mono);
            font-size: 2.0vmin; 
            color: #777; 
            margin-top: 0.2vmin;
            text-transform: uppercase; 
            letter-spacing: 0.1em;
            text-align: center;
            width: 100%;
        }

        .message {
            font-family: var(--font-mono);
            font-size: 3vmin;
            color: var(--text-color-secondary);
        }

        .hidden { 
            display: none !important;
        }

        #temp-graph-container { 
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            align-items: center;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 0.5vmin 0; 
        }
        .graph-title {
            font-family: var(--font-mono);
            font-size: 2.0vmin; 
            color: var(--text-color-primary);
            margin-bottom: 0.5vmin; 
            text-align: center;
            font-weight: 400; 
            flex-shrink: 0; 
        }
        .svg-graph-wrapper { 
            width: 100%; 
            height: 100%; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0; 
        }
        #temp-line-graph { 
        }
        .axis-label {
            font-family: var(--font-mono);
            font-size: 1.5vmin; 
            fill: var(--text-color-secondary);
            font-weight: 300; 
        }
        .temp-value-label {
            font-family: var(--font-mono);
            font-size: 4.0vmin; 
            fill: var(--text-color-primary);
            font-weight: 600; 
        }
        #temp-line-graph .graph-line {
            stroke: var(--text-color-primary);
            stroke-width: 2.5; 
        }
        #temp-line-graph .graph-circle {
            fill: var(--text-color-primary);
            stroke: var(--panel-bg-color); 
            stroke-width: 1;
        }
        #temp-line-graph .axis {
            stroke: var(--line-color);
        }
    </style>
</head>
<body>
    <div class="aspect-ratio-wrapper">
        <div class="signage-container">
            <div class="signage-header">
                <span class="status-text-left">SYSTEM STATUS: ONLINE</span>
                <span class="status-text-right" id="current-location-display">LOCATION: KAWASAKI</span>
            </div>
            <div class="content-area"> 
                <div class="time-section">
                    <div id="time" class="font-roboto-mono">--:--:--</div>
                    <div id="date-container"> 
                    </div>
                </div>
                <div class="weather-section">
                    <div class="weather-icon-container"> 
                        <div id="weather-icon">
                            <span class="material-symbols-outlined">help</span>
                        </div>
                    </div>
                    <div class="weather-details">
                    </div>
                </div>
            </div>
             <div class="signage-footer">
                <span class="status-text-left" id="data-source-info">DATA RETRIEVAL: ACTIVE</span>
                <span class="status-text-right">ARCHIVE MODE</span>
            </div>
        </div>
    </div>

    <script>
        var latitude = 35.5300;
        var longitude = 139.7036;

        var timeElement = document.getElementById('time');
        var dateContainerElement = document.getElementById('date-container'); 
        
        var weatherIconContainerElement = document.querySelector('.weather-icon-container');
        var weatherIconElement = document.getElementById('weather-icon');
        
        var weatherDetailsElement = document.querySelector('.weather-details'); 
        var weatherSectionElement = document.querySelector('.weather-section'); 
        var timeSectionElement = document.querySelector('.time-section'); 
        var contentAreaElement = document.querySelector('.content-area'); 
        
        var currentLocationDisplay = document.getElementById('current-location-display');
        var dataSourceInfo = document.getElementById('data-source-info');

        var todayWeatherData = null;
        var tomorrowWeatherData = null;
        var weeklyMaxTemps = []; 
        var weeklyDates = []; 

        var newsHeadlines = []; 
        var dateNewsDisplayState = 0; 
        var dateNewsToggleIntervalId = null; 
        var newsFetchIntervalId = null; 

        var displayState = 0; 
        var weatherIntervalId = null;
        var displayToggleIntervalId = null;
        var currentRssItem = null; 
        var rssFetchIntervalId = null; 

        var RSS_FEEDS = [ 
            "https://note.com/_tutinu/rss",
            "https://note.com/raikan/rss",
            "https://note.com/bluemist/rss",
            "https://note.com/yuepicos/rss"
        ];
        var MAX_WEATHER_DISPLAY_STATES = 5; 

        var animationDuration = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--animation-duration') || '0.4') * 1000;


        function customPadStart(str, targetLength, padString) {
            str = String(str);
            targetLength = targetLength >> 0; 
            padString = String((typeof padString !== 'undefined' ? padString : ' '));
            if (str.length > targetLength) {
                return String(str);
            } else {
                targetLength = targetLength - str.length;
                if (targetLength > padString.length) {
                    padString += padString.repeat(targetLength / padString.length); 
                }
                return padString.slice(0, targetLength) + String(str);
            }
        }
        
        function animateElementSwitch(element, newContentCallback) {
            if (!element) { 
                newContentCallback();
                return;
            }
            element.style.opacity = 0; 
            setTimeout(function() {
                newContentCallback(); 
                if (element) { 
                    element.style.opacity = 1; 
                }
            }, animationDuration > 0 ? animationDuration / 2 : 0); 
        }


        function updateDateOrNewsDisplay() {
            animateElementSwitch(dateContainerElement, function() {
                if (!dateContainerElement) return;
                dateContainerElement.innerHTML = ''; 

                var dateTextDiv = document.createElement('div');
                dateTextDiv.id = 'date'; 
                dateTextDiv.style.fontFamily = 'var(--font-mono)';
                dateTextDiv.style.color = 'var(--text-color-secondary)';
                dateTextDiv.style.padding = '0 0.5vmin';
                dateTextDiv.style.lineHeight = '1.2';
                dateTextDiv.style.fontWeight = '800'; 
                dateTextDiv.style.textAlign = 'center';
                dateTextDiv.style.width = '100%'; 
                dateTextDiv.style.overflow = 'hidden'; 
                dateTextDiv.style.textOverflow = 'ellipsis'; 


                var attributionTextDiv = document.createElement('div');
                attributionTextDiv.id = 'attribution-text'; 
                attributionTextDiv.style.fontFamily = 'var(--font-mono)';
                attributionTextDiv.style.fontSize = '1.5vmin';
                attributionTextDiv.style.color = '#666';
                attributionTextDiv.style.marginTop = '0.5vmin';
                attributionTextDiv.style.letterSpacing = '0.05em';
                attributionTextDiv.style.textAlign = 'center';

                if (dateNewsDisplayState === 0) { 
                    var now = new Date();
                    var year = now.getFullYear();
                    var month = customPadStart(now.getMonth() + 1, 2, '0');
                    var day = customPadStart(now.getDate(), 2, '0');
                    var dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][now.getDay()];
                    dateTextDiv.textContent = year + "年" + month + "月" + day + "日 (" + dayOfWeek + ")";
                    dateTextDiv.style.fontSize = "4vmin"; 
                    dateTextDiv.style.whiteSpace = "nowrap"; 
                    
                    attributionTextDiv.textContent = "天気: Open-Meteo / ニュース: Zenn/note"; 
                    dateContainerElement.appendChild(dateTextDiv);
                    dateContainerElement.appendChild(attributionTextDiv);

                } else if (dateNewsDisplayState > 0 && newsHeadlines.length >= dateNewsDisplayState) { 
                    var newsIndex = dateNewsDisplayState - 1;
                    dateTextDiv.textContent = newsHeadlines[newsIndex]; 
                    dateTextDiv.style.fontSize = "3.5vmin"; 
                    dateTextDiv.style.fontWeight = "800"; 
                    dateTextDiv.style.whiteSpace = "nowrap"; 
                    dateContainerElement.appendChild(dateTextDiv);
                } else { 
                    var now = new Date();
                    var year = now.getFullYear();
                    var month = customPadStart(now.getMonth() + 1, 2, '0');
                    var day = customPadStart(now.getDate(), 2, '0');
                    var dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][now.getDay()];
                    dateTextDiv.textContent = year + "年" + month + "月" + day + "日 (" + dayOfWeek + ")";
                    dateTextDiv.style.fontSize = "4vmin";
                    dateTextDiv.style.fontWeight = "300";
                    dateTextDiv.style.whiteSpace = "nowrap";
                    attributionTextDiv.textContent = "天気: Open-Meteo / ニュース: Zenn/note";
                    dateContainerElement.appendChild(dateTextDiv);
                    dateContainerElement.appendChild(attributionTextDiv);
                    dateNewsDisplayState = 0; 
                }
            });
        }


        function updateTime() { 
            var now = new Date();
            var hours = customPadStart(now.getHours(), 2, '0');
            var minutes = customPadStart(now.getMinutes(), 2, '0');
            var seconds = customPadStart(now.getSeconds(), 2, '0');
            if (timeElement) { 
                timeElement.textContent = hours + ":" + minutes + ":" + seconds;
            }
        }


        function fetchNews() { 
            var rssUrl = "https://zenn.dev/topics/ai/feed"; 
            var proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(rssUrl);
            
            if(dataSourceInfo) dataSourceInfo.textContent = "ニュース取得中...";

            fetch(proxyUrl, { cache: 'no-store' }) 
                .then(function(response) {
                    if (!response.ok) {
                        return response.text().then(function(text) {
                            console.error("Zenn RSS取得エラーレスポンス:", text);
                            if(dataSourceInfo) dataSourceInfo.textContent = "ニュース取得エラー";
                            throw new Error("Zenn RSS取得エラー: " + response.status + " - " + response.statusText + " (URL: " + proxyUrl + ")");
                        });
                    }
                    return response.text();
                })
                .then(function(str) {
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(str, "text/xml");
                    var errorNode = xmlDoc.querySelector("parsererror"); 
                    if (errorNode) {
                        console.error("Zenn RSS解析エラー (parsererror):", errorNode.textContent);
                        if(dataSourceInfo) dataSourceInfo.textContent = "ニュース解析エラー";
                        throw new Error("Zenn RSS解析エラー");
                    }
                    var items = xmlDoc.getElementsByTagName("entry");
                    if (items.length === 0) { 
                        items = xmlDoc.getElementsByTagName("item");
                    }

                    var fetchedHeadlines = [];
                    for (var i = 0; i < items.length; i++) { 
                        var titleElement = items[i].getElementsByTagName("title")[0];
                        if (titleElement) {
                            fetchedHeadlines.push(titleElement.textContent.trim()); 
                        }
                    }
                    newsHeadlines = fetchedHeadlines; 

                    if (newsHeadlines.length === 0) {
                        console.warn("Zennニュースヘッドラインを取得できませんでした。");
                        if(dataSourceInfo && dataSourceInfo.textContent.includes("ニュース取得中")) dataSourceInfo.textContent = "ニュースなし";
                    } else {
                        if(dataSourceInfo && dataSourceInfo.textContent.includes("ニュース取得中")) dataSourceInfo.textContent = "DATA RETRIEVAL: ACTIVE";
                    }
                    if (dateNewsDisplayState > newsHeadlines.length) { 
                        dateNewsDisplayState = 0; 
                    }
                    updateDateOrNewsDisplay(); 
                })
                .catch(function(error) {
                    console.error("Zennニュース取得または解析最終エラー:", error);
                    newsHeadlines = []; 
                    if(dataSourceInfo) dataSourceInfo.textContent = "ニュース取得失敗";
                    dateNewsDisplayState = 0; 
                    updateDateOrNewsDisplay();
                });
        }

        function fetchRandomRSSFeed() {
            if (!RSS_FEEDS || RSS_FEEDS.length === 0) { 
                console.error("RSS_FEEDS 配列が定義されていません。");
                if(dataSourceInfo) dataSourceInfo.textContent = "RSS設定エラー";
                currentRssItem = { title: "RSS設定エラー", description: "", author: "" };
                if (displayState === 3 || displayState === 4) updateWeatherDisplay();
                return;
            }
            var randomIndex = Math.floor(Math.random() * RSS_FEEDS.length);
            var rssUrl = RSS_FEEDS[randomIndex];
            var proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(rssUrl);
            if(dataSourceInfo) dataSourceInfo.textContent = "RSSフィード取得中...";

            fetch(proxyUrl, { cache: 'no-store' })
                .then(function(response) {
                    if (!response.ok) {
                        return response.text().then(function(text) {
                            console.error("Note RSS取得エラーレスポンス ("+rssUrl+"): " + response.status, text);
                            if(dataSourceInfo) dataSourceInfo.textContent = "RSS取得エラー";
                            currentRssItem = { title: "RSS取得エラー", description: "フィードの読み込みに失敗しました。", author: "N/A" };
                            if (displayState === 3 || displayState === 4) updateWeatherDisplay();
                            throw new Error("Note RSS取得エラー: " + response.status);
                        });
                    }
                    return response.text();
                })
                .then(function(str) {
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(str, "text/xml");
                    var errorNode = xmlDoc.querySelector("parsererror");
                    if (errorNode) {
                        console.error("Note RSS解析エラー ("+rssUrl+"): ", errorNode.textContent);
                        if(dataSourceInfo) dataSourceInfo.textContent = "RSS解析エラー";
                        currentRssItem = { title: "RSS解析エラー", description: "フィードの解析に失敗しました。", author: "N/A" };
                        if (displayState === 3 || displayState === 4) updateWeatherDisplay();
                        throw new Error("Note RSS解析エラー");
                    }

                    var items = xmlDoc.getElementsByTagName("item"); 
                    var channelTitle = "不明な作成者";
                    var channelElement = xmlDoc.getElementsByTagName("channel")[0];
                    if (channelElement) {
                        var channelTitleElement = channelElement.getElementsByTagName("title")[0];
                        if (channelTitleElement) {
                            channelTitle = channelTitleElement.textContent.trim();
                        }
                    }


                    if (items.length > 0) {
                        var randomItemIndex = Math.floor(Math.random() * items.length);
                        var item = items[randomItemIndex];
                        var title = item.getElementsByTagName("title")[0] ? item.getElementsByTagName("title")[0].textContent.trim() : "タイトルなし";
                        var descriptionNode = item.getElementsByTagName("description")[0];
                        var description = "概要なし";
                        if (descriptionNode) {
                            var tempDiv = document.createElement("div");
                            tempDiv.innerHTML = descriptionNode.textContent; 
                            var plainText = tempDiv.textContent || tempDiv.innerText || "";
                            description = plainText.trim().substring(0, 100) + (plainText.length > 100 ? "..." : ""); 
                        }
                        currentRssItem = { title: title, description: description, author: channelTitle };
                    } else {
                        console.warn("RSSアイテムが見つかりませんでした ("+rssUrl+").");
                        currentRssItem = { title: "記事なし", description: "このフィードには記事がありません。", author: channelTitle };
                    }
                    if (displayState === 3 || displayState === 4) { 
                        updateWeatherDisplay();
                    }
                })
                .catch(function(error) {
                    console.error("ランダムRSS取得最終エラー ("+rssUrl+"): ", error);
                    currentRssItem = { title: "RSS取得失敗", description: "読み込みに問題がありました。", author: "N/A" };
                    if (displayState === 3 || displayState === 4) updateWeatherDisplay();
                });
        }


        function getWeatherInfoFromWMOCode(code) {
            var wmoMap = {
                0: { description: "快晴", icon: "sunny" }, 1: { description: "ほぼ快晴", icon: "partly_cloudy_day" },
                2: { description: "所により曇り", icon: "partly_cloudy_day" }, 3: { description: "曇り", icon: "cloud" },
                45: { description: "霧", icon: "foggy" }, 48: { description: "霧氷", icon: "ac_unit" },
                51: { description: "霧雨 (弱)", icon: "rainy_light" }, 53: { description: "霧雨", icon: "rainy_light" },
                55: { description: "霧雨 (強)", icon: "rainy_light" }, 56: { description: "着氷性の霧雨", icon: "sleet" },
                57: { description: "着氷性の霧雨", icon: "sleet" }, 61: { description: "雨 (弱)", icon: "rainy" },
                63: { description: "雨", icon: "rainy" }, 65: { description: "雨 (強)", icon: "rainy_heavy" },
                66: { description: "着氷性の雨", icon: "sleet" }, 67: { description: "着氷性の雨", icon: "sleet" },
                71: { description: "雪 (弱)", icon: "weather_snowy" }, 73: { description: "雪", icon: "weather_snowy" },
                75: { description: "雪 (強)", icon: "weather_snowy" }, 77: { description: "霧雪", icon: "grain" },
                80: { description: "にわか雨 (弱)", icon: "rainy_light" }, 81: { description: "にわか雨", icon: "rainy" },
                82: { description: "にわか雨 (強)", icon: "thunderstorm" }, 85: { description: "にわか雪 (弱)", icon: "weather_snowy" },
                86: { description: "にわか雪 (強)", icon: "weather_snowy" }, 95: { description: "雷雨", icon: "thunderstorm" },
                96: { description: "雷雨 (雹)", icon: "thunderstorm" }, 99: { description: "雷雨 (雹)", icon: "thunderstorm" },
            };
            return wmoMap[code] || { description: "コード:" + code, icon: "help" };
        }

        function renderTemperatureLineGraph(temps, dates) {
            var graphContainer = weatherDetailsElement.querySelector('#temp-graph-container'); 
            if (!graphContainer) {
                var graphDisplayWrapper = weatherDetailsElement.querySelector('#graph-display-wrapper');
                if(graphDisplayWrapper) {
                    graphContainer = document.createElement('div');
                    graphContainer.id = 'temp-graph-container';
                    graphDisplayWrapper.appendChild(graphContainer);
                } else {
                    console.error("graph-display-wrapper not found for graph rendering");
                    return;
                }
            }
            graphContainer.innerHTML = ''; 

            if (!temps || temps.length === 0) {
                graphContainer.innerHTML = '<div class="message" style="text-align:center; width:100%;">比較できる気温データがありません</div>';
                return;
            }
            
            var graphTitle = document.createElement('div');
            graphTitle.className = 'graph-title';
            graphTitle.textContent = '週間最高気温';
            graphContainer.appendChild(graphTitle);

            var svgWrapper = document.createElement('div');
            svgWrapper.className = 'svg-graph-wrapper';
            graphContainer.appendChild(svgWrapper);

            var svgNS = "http://www.w3.org/2000/svg";
            var svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("id", "temp-line-graph");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
            svgWrapper.appendChild(svg);
            
            var svgWrapperRect = svgWrapper.getBoundingClientRect();
            var svgEffectiveWidth = svgWrapperRect.width;
            var svgEffectiveHeight = svgWrapperRect.height;

            if (svgEffectiveWidth <= 0 || svgEffectiveHeight <= 0) { 
                var parentRect = graphContainer.getBoundingClientRect(); 
                svgEffectiveWidth = parentRect.width > 0 ? parentRect.width : 200; 
                svgEffectiveHeight = parentRect.height > 0 ? parentRect.height * 0.85 : 150; 
                 if (svgEffectiveWidth <= 0 || svgEffectiveHeight <= 0) { 
                     svgEffectiveWidth = 200; svgEffectiveHeight = 150;
                }
            }

            var margin = { 
                top: svgEffectiveHeight * 0.08,  
                right: svgEffectiveWidth * 0.08, 
                bottom: svgEffectiveHeight * 0.20, 
                left: svgEffectiveWidth * 0.18    
            }; 
            var graphWidth = svgEffectiveWidth - margin.left - margin.right;
            var graphHeight = svgEffectiveHeight - margin.top - margin.bottom;

            if (graphWidth <=10 || graphHeight <=10) { 
                graphContainer.innerHTML = '<div class="message" style="text-align:center; width:100%;">グラフ表示領域不足</div>';
                return;
            }
            
            svg.setAttribute("viewBox", "0 0 " + svgEffectiveWidth + " " + svgEffectiveHeight);


            var g = document.createElementNS(svgNS, "g");
            g.setAttribute("transform", "translate(" + margin.left + "," + margin.top + ")");
            svg.appendChild(g);

            var dataPoints = [];
            for (var i = 0; i < temps.length; i++) {
                if (temps[i] !== null) {
                    var label = "";
                    if (i === 0) label = "今日";
                    else if (i === 1) label = "明日";
                    else {
                        var dateObj = new Date(dates[i]);
                        label = (dateObj.getMonth() + 1) + "/" + dateObj.getDate();
                    }
                    dataPoints.push({ label: label, temp: temps[i], dayIndex: i });
                }
            }
            
            if (dataPoints.length === 0) { 
                svgWrapper.innerHTML = '<div class="message">データなし</div>';
                return;
            }

            var yMin = Infinity, yMax = -Infinity;
            dataPoints.forEach(function(p){
                yMin = Math.min(yMin, p.temp);
                yMax = Math.max(yMax, p.temp);
            });
            if (yMin === Infinity) { yMin = 0; yMax = 30;} 
            
            var yPadding = (yMax - yMin) * 0.15 || 2; 
            yMin = Math.floor(yMin - yPadding);
            yMax = Math.ceil(yMax + yPadding);
            if (yMin === yMax) { yMin -= 2; yMax += 2; } 

            function scaleY(temp) {
                if (yMax === yMin) return graphHeight / 2; 
                return graphHeight - ((temp - yMin) / (yMax - yMin)) * graphHeight;
            }
            function scaleX(dayIndex) {
                if (dataPoints.length <= 1) return graphWidth / 2; 
                return (graphWidth / (dataPoints.length -1 )) * dayIndex; 
            }


            var yAxisLine = document.createElementNS(svgNS, "line");
            yAxisLine.setAttribute("x1", "0"); yAxisLine.setAttribute("y1", "0");
            yAxisLine.setAttribute("x2", "0"); yAxisLine.setAttribute("y2", graphHeight);
            yAxisLine.setAttribute("class", "axis"); 
            g.appendChild(yAxisLine);

            var numYTicks = 2; 
            for (var i = 0; i <= numYTicks; i++) {
                var val = yMin + (i/numYTicks) * (yMax - yMin);
                var yLabel = document.createElementNS(svgNS, "text");
                yLabel.setAttribute("class", "axis-label");
                yLabel.setAttribute("x", -5); 
                yLabel.setAttribute("y", scaleY(val));
                yLabel.setAttribute("dy", "0.35em");
                yLabel.setAttribute("text-anchor", "end");
                yLabel.textContent = Math.round(val) + "°";
                g.appendChild(yLabel);
            }
            
            var xAxisLine = document.createElementNS(svgNS, "line");
            xAxisLine.setAttribute("x1", "0"); xAxisLine.setAttribute("y1", graphHeight);
            xAxisLine.setAttribute("x2", graphWidth); xAxisLine.setAttribute("y2", graphHeight);
            xAxisLine.setAttribute("class", "axis"); 
            g.appendChild(xAxisLine);

            var linePath = "";
            dataPoints.forEach(function(p, i_dp) { 
                var xPos = scaleX(p.dayIndex); 
                var yPos = scaleY(p.temp);
                if (i_dp === 0) { 
                    linePath += "M" + xPos + "," + yPos;
                } else {
                    linePath += " L" + xPos + "," + yPos;
                }
            });


            if (linePath !== "") {
                var line = document.createElementNS(svgNS, "path");
                line.setAttribute("d", linePath);
                line.setAttribute("fill", "none");
                line.setAttribute("class", "graph-line"); 
                line.setAttribute("stroke-linecap", "round");
                line.setAttribute("stroke-linejoin", "round");
                g.appendChild(line);
            }
            
            dataPoints.forEach(function(p) {
                var xPos = scaleX(p.dayIndex);
                var yPos = scaleY(p.temp);
                var circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("cx", xPos);
                circle.setAttribute("cy", yPos);
                circle.setAttribute("r", "2.5"); 
                circle.setAttribute("class", "graph-circle"); 
                g.appendChild(circle);

                var tempValLabel = document.createElementNS(svgNS, "text");
                tempValLabel.setAttribute("class", "temp-value-label");
                tempValLabel.setAttribute("x", xPos);
                tempValLabel.setAttribute("y", yPos - 6); 
                tempValLabel.setAttribute("text-anchor", "middle");
                tempValLabel.textContent = p.temp + "°";
                g.appendChild(tempValLabel);

                var xLabel = document.createElementNS(svgNS, "text");
                xLabel.setAttribute("class", "axis-label");
                xLabel.setAttribute("x", xPos);
                xLabel.setAttribute("y", graphHeight + (margin.bottom * 0.5)); 
                xLabel.setAttribute("text-anchor", "middle");
                xLabel.textContent = p.label;
                g.appendChild(xLabel);
            });
        }

        function updateWeatherDisplay() {
            animateElementSwitch(weatherDetailsElement, function() { // weatherDetailsElement全体をアニメーション対象に
                if (!weatherDetailsElement || !weatherIconContainerElement || !weatherIconElement) return;
                weatherDetailsElement.innerHTML = ''; 
                weatherIconContainerElement.style.display = 'flex'; 
                weatherDetailsElement.style.flex = '0.6';       
                weatherDetailsElement.style.paddingLeft = '1.5vmin'; 

                if (displayState === 3 || displayState === 4) { 
                    weatherIconElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 40vmin; color: #ffffffff;">rss_feed</span>';
                    
                    var rssDisplayWrapper = document.createElement('div');
                    rssDisplayWrapper.id = 'rss-feed-display'; 
                    
                    var rssTitleDiv = document.createElement('div');
                    rssTitleDiv.className = 'rss-title';
                    
                    var rssDescDiv = document.createElement('div');
                    rssDescDiv.className = 'rss-description';

                    var rssAuthorDiv = document.createElement('div'); 
                    rssAuthorDiv.className = 'rss-author';

                    if (currentRssItem) {
                        rssTitleDiv.textContent = currentRssItem.title;
                        rssDescDiv.textContent = currentRssItem.description;
                        rssAuthorDiv.textContent = currentRssItem.author ? "by " + currentRssItem.author : "";
                    } else {
                        rssTitleDiv.textContent = "RSSフィード読込中...";
                        rssDescDiv.textContent = "";
                        rssAuthorDiv.textContent = "";
                    }
                    rssDisplayWrapper.appendChild(rssTitleDiv);
                    rssDisplayWrapper.appendChild(rssDescDiv);
                    if (currentRssItem && currentRssItem.author && currentRssItem.author !== "N/A" && currentRssItem.author !== "不明な作成者") { 
                        rssDisplayWrapper.appendChild(document.createElement('br')); 
                        rssDisplayWrapper.appendChild(rssAuthorDiv);
                    }
                    weatherDetailsElement.appendChild(rssDisplayWrapper);
                    
                } else if (displayState === 2) { 
                    var firstValidTemp = null;
                    var lastValidTemp = null;
                    for (var i = 0; i < weeklyMaxTemps.length; i++) {
                        if (weeklyMaxTemps[i] !== null) {
                            if (firstValidTemp === null) firstValidTemp = weeklyMaxTemps[i];
                            lastValidTemp = weeklyMaxTemps[i];
                        }
                    }
                    var trendingIconName = "trending_flat";
                    if (firstValidTemp !== null && lastValidTemp !== null) {
                        var diff = lastValidTemp - firstValidTemp;
                        if (diff >= 3) trendingIconName = "trending_up";
                        else if (diff <= -3) trendingIconName = "trending_down";
                    }
                    weatherIconElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 40vmin; color: #ffffffff;">' + trendingIconName + '</span>';


                    var graphDisplayWrapper = document.createElement('div');
                    graphDisplayWrapper.id = 'graph-display-wrapper'; 
                    
                    var tempGraphContainer = document.createElement('div');
                    tempGraphContainer.id = 'temp-graph-container'; 
                    graphDisplayWrapper.appendChild(tempGraphContainer);
                    weatherDetailsElement.appendChild(graphDisplayWrapper);

                    if (weeklyMaxTemps.length > 0 && weeklyDates.length > 0) {
                        setTimeout(function() { 
                            renderTemperatureLineGraph(weeklyMaxTemps, weeklyDates);
                        }, 0); 
                    } else {
                        tempGraphContainer.innerHTML = '<div class="message" style="text-align:center; width:100%;">週間気温データ取得中...</div>';
                    }
                } else { 
                    var weatherInfoDisplay = document.createElement('div');
                    weatherInfoDisplay.id = 'weather-info-display'; 
                    
                    var tempEl = document.createElement('div');
                    tempEl.id = 'temperature'; 
                    tempEl.className = 'font-roboto-mono';
                    weatherInfoDisplay.appendChild(tempEl);

                    var descEl = document.createElement('div');
                    descEl.id = 'weather-description';
                    descEl.className = 'font-noto';
                    weatherInfoDisplay.appendChild(descEl);

                    var cityEl = document.createElement('div');
                    cityEl.id = 'city-name';
                    cityEl.className = 'font-noto';
                    weatherInfoDisplay.appendChild(cityEl);
                    
                    weatherDetailsElement.appendChild(weatherInfoDisplay);

                    if (displayState === 0 && todayWeatherData) { 
                        tempEl.textContent = todayWeatherData.temperature + "°C";
                        var weatherInfo = getWeatherInfoFromWMOCode(todayWeatherData.weathercode);
                        weatherIconElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 40vmin; color: #ffffffff;">' + weatherInfo.icon + '</span>';
                        var descText = "今日: " + weatherInfo.description;
                        if (todayWeatherData.max_temp !== null && todayWeatherData.min_temp !== null) {
                            descText += " (最高 " + todayWeatherData.max_temp + "°C / 最低 " + todayWeatherData.min_temp + "°C)";
                        }
                        descEl.textContent = descText;
                    } else if (displayState === 1 && tomorrowWeatherData) { 
                        tempEl.textContent = tomorrowWeatherData.max_temp !== null ? tomorrowWeatherData.max_temp + "°C" : '--°C';
                        var weatherInfo = getWeatherInfoFromWMOCode(tomorrowWeatherData.weathercode);
                        weatherIconElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 40vmin; color: #ffffffff;">' + weatherInfo.icon + '</span>';
                        var descText = "明日: " + weatherInfo.description;
                        if (tomorrowWeatherData.max_temp !== null && tomorrowWeatherData.min_temp !== null) {
                            descText += " (最高 " + tomorrowWeatherData.max_temp + "°C / 最低 " + tomorrowWeatherData.min_temp + "°C)";
                        }
                        descEl.textContent = descText;
                    } else {
                        weatherIconElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 40vmin; color: #ffffffff;">help</span>';
                        tempEl.textContent = '--°C';
                        descEl.textContent = "読込中...";
                    }
                    cityEl.textContent = '川崎市';
                }
            });
            // アイコンコンテナも同様にアニメーション
            animateElementSwitch(weatherIconContainerElement, function() {
                // アイコンの内容は updateWeatherDisplay の各条件分岐内で設定済みなので、ここでは何もしない
            });
            if(currentLocationDisplay) currentLocationDisplay.textContent = 'LOCATION: KAWASAKI'; 
        }


        function fetchWeather() {
            var apiUrl = "https://api.open-meteo.com/v1/forecast?latitude=" + latitude + "&longitude=" + longitude + "&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia/Tokyo&forecast_days=7";
            if(dataSourceInfo) dataSourceInfo.textContent = "気象データ取得中...";

            fetch(apiUrl)
                .then(function(response) {
                    if (!response.ok) {
                        var errorText = "APIエラー: " + response.status + " " + response.statusText;
                        return response.text().then(function(text) {
                            try { var errorData = JSON.parse(text); if (errorData && errorData.reason) { errorText = "APIエラー: " + errorData.reason; }} catch (e) {}
                            if(dataSourceInfo) dataSourceInfo.textContent = "気象データ取得エラー";
                            throw new Error(errorText);
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.current_weather && data.daily && data.daily.time && data.daily.time.length >= 7) {
                        todayWeatherData = {
                            temperature: Math.round(data.current_weather.temperature),
                            weathercode: data.current_weather.weathercode,
                            max_temp: data.daily.temperature_2m_max[0] !== null ? Math.round(data.daily.temperature_2m_max[0]) : null,
                            min_temp: data.daily.temperature_2m_min[0] !== null ? Math.round(data.daily.temperature_2m_min[0]) : null,
                        };
                        tomorrowWeatherData = {
                            weathercode: data.daily.weathercode[1],
                            max_temp: data.daily.temperature_2m_max[1] !== null ? Math.round(data.daily.temperature_2m_max[1]) : null,
                            min_temp: data.daily.temperature_2m_min[1] !== null ? Math.round(data.daily.temperature_2m_min[1]) : null,
                        };
                        
                        weeklyMaxTemps = [];
                        weeklyDates = [];
                        for (var i = 0; i < 7; i++) {
                            weeklyMaxTemps.push(data.daily.temperature_2m_max[i] !== null ? Math.round(data.daily.temperature_2m_max[i]) : null);
                            weeklyDates.push(data.daily.time[i]); 
                        }
                        if(dataSourceInfo) dataSourceInfo.textContent = "DATA RETRIEVAL: ACTIVE";


                        if (!displayToggleIntervalId) {
                            updateWeatherDisplay(); 
                            displayToggleIntervalId = setInterval(function() {
                                displayState = (displayState + 1) % MAX_WEATHER_DISPLAY_STATES; 
                                updateWeatherDisplay();
                            }, 5000); 
                        } else if (displayState !== 3 && displayState !== 4) { 
                            updateWeatherDisplay(); 
                        }
                    } else {
                        console.warn('APIデータ形式エラー:', JSON.stringify(data, null, 2));
                        todayWeatherData = null; tomorrowWeatherData = null; weeklyMaxTemps = []; weeklyDates = [];
                        displayState = 0; 
                        if(dataSourceInfo) dataSourceInfo.textContent = "気象データ形式エラー";
                        updateWeatherDisplay(); 
                        if (displayToggleIntervalId) { clearInterval(displayToggleIntervalId); displayToggleIntervalId = null; }
                    }
                })
                .catch(function(error) {
                    console.error('天気情報取得失敗:', error);
                    todayWeatherData = null; tomorrowWeatherData = null; weeklyMaxTemps = []; weeklyDates = [];
                    displayState = 0; 
                    if(dataSourceInfo) dataSourceInfo.textContent = "気象情報取得失敗";
                    updateWeatherDisplay(); 
                    if (displayToggleIntervalId) { clearInterval(displayToggleIntervalId); displayToggleIntervalId = null; }
                });
        }
        
        function setWeatherSectionHeight() {
            if (!contentAreaElement || !timeSectionElement || !weatherSectionElement) return; 

            var contentAreaStyle = getComputedStyle(contentAreaElement);
            var timeSectionStyle = getComputedStyle(timeSectionElement);
            var weatherSectionStyle = getComputedStyle(weatherSectionElement);

            var contentAreaHeight = contentAreaElement.getBoundingClientRect().height;
            var timeSectionHeight = timeSectionElement.getBoundingClientRect().height;
            
            var timeSectionMarginBottom = parseFloat(timeSectionStyle.marginBottom) || 0;
            
            var weatherSectionPaddingTop = parseFloat(weatherSectionStyle.paddingTop) || 0;
            var weatherSectionPaddingBottom = parseFloat(weatherSectionStyle.paddingBottom) || 0;
            var weatherSectionBorderTop = parseFloat(weatherSectionStyle.borderTopWidth) || 0;
            var weatherSectionBorderBottom = parseFloat(weatherSectionStyle.borderBottomWidth) || 0;

            var availableHeight = contentAreaHeight - timeSectionHeight - timeSectionMarginBottom - weatherSectionPaddingTop - weatherSectionPaddingBottom - weatherSectionBorderTop - weatherSectionBorderBottom;
            
            if (availableHeight > 0) {
                weatherSectionElement.style.height = availableHeight + "px";
            } else {
                weatherSectionElement.style.height = (contentAreaHeight * 0.5) + "px"; 
                console.warn("Weather section height calculation resulted in non-positive value. Using fallback.");
            }
        }


        updateTime(); 
        updateDateOrNewsDisplay(); 
        fetchWeather(); 
        fetchNews(); 
        fetchRandomRSSFeed(); 
        setWeatherSectionHeight(); 

        setInterval(updateTime, 1000); 

        if (dateNewsToggleIntervalId) clearInterval(dateNewsToggleIntervalId);
        dateNewsToggleIntervalId = setInterval(function() { 
            var cycleLength = newsHeadlines.length > 0 ? newsHeadlines.length + 1 : 1;
            dateNewsDisplayState = (dateNewsDisplayState + 1) % cycleLength; 
            updateDateOrNewsDisplay();
        }, 5000); 


        if (weatherIntervalId) clearInterval(weatherIntervalId);
        weatherIntervalId = setInterval(fetchWeather, 15 * 60 * 1000); 

        if (newsFetchIntervalId) clearInterval(newsFetchIntervalId);
        newsFetchIntervalId = setInterval(fetchNews, 60 * 60 * 1000); 

        if (rssFetchIntervalId) clearInterval(rssFetchIntervalId);
        rssFetchIntervalId = setInterval(function() {
            // RSS表示の最初のサイクル(displayState === 3)の時に新しい記事を取得する
            if (displayState === 3) { 
                 fetchRandomRSSFeed(); 
            }
        }, 5000 * MAX_WEATHER_DISPLAY_STATES); // 全ての天気の表示サイクルが一巡したタイミングで更新を試みる

        window.onresize = function() { 
            maintainAspectRatio(); 
            setWeatherSectionHeight(); 
            if (displayState === 2 && weeklyMaxTemps.length > 0) { 
                renderTemperatureLineGraph(weeklyMaxTemps, weeklyDates);
            }
        };
        
        function maintainAspectRatio() {
            var wrapper = document.querySelector('.aspect-ratio-wrapper');
            if (!wrapper) {
                console.error(".aspect-ratio-wrapper not found for maintainAspectRatio");
                return;
            }
            var viewportWidth = window.innerWidth;
            var viewportHeight = window.innerHeight;
            var newWidth, newHeight;
            var targetWidth = viewportWidth * 0.95;
            var targetHeight = viewportHeight * 0.95;

            if (targetWidth / targetHeight > 16 / 9) {
                newHeight = targetHeight;
                newWidth = newHeight * 16 / 9;
            } else {
                newWidth = targetWidth;
                newHeight = newWidth * 9 / 16;
            }
            wrapper.style.width = newWidth + "px";
            wrapper.style.height = newHeight + "px";
        }
        maintainAspectRatio(); 
        
    </script>
</body>
</html>
