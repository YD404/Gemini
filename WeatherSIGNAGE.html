<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>川崎市 時刻・天気</title>
    <script src="https://cdn.tailwindcss.com"></script> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #111111;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .signage-container {
            width: 100%;
            height: 100%;
            background-color: #222222;
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
            border: 10px solid #555555;
            box-sizing: border-box;
            position: relative;
        }

        .aspect-ratio-wrapper {
            width: 95vw;
            max-width: calc(95vh * 16 / 9); /* 16:9 横表示 */
            height: calc(95vw * 9 / 16);   /* 16:9 横表示 */
            max-height: 95vh;
            position: relative;
            display: flex; 
            justify-content: center;
            align-items: center;
        }

        .content-area { 
            display: flex;
            flex-direction: column; 
            width: 100%;
            height: 100%;
            padding: 3vmin;
            box-sizing: border-box;
        }

        .time-section {
            background-color: #333333;
            border: 2px solid #666666;
            border-radius: 8px;
            padding: 2vmin 3vmin; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #dddddd;
            margin-bottom: 3vmin; 
        }

        .weather-section {
            flex-grow: 1; 
            background-color: #333333;
            border: 2px solid #666666;
            border-radius: 8px;
            padding: 2vmin;
            box-sizing: border-box;
            display: flex; 
            flex-direction: row; 
            align-items: center;
            text-align: center;
            color: #dddddd;
        }

        #time {
            font-family: 'Roboto Mono', monospace;
            font-size: 15vmin;
            font-weight: 700;
            line-height: 1;
            color: #eeeeee;
        }

        #date-container { 
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            margin-top: 1vmin;
            min-height: 7vh; 
        }

        #date { 
            color: #cccccc;
            text-align: center;
            overflow: hidden; 
            padding-left: 1vmin; 
            padding-right: 1vmin;
            line-height: 1.3; 
        }
        #attribution-text {
            font-size: 1.8vmin; 
            color: #888888; 
            margin-top: 0.5vmin;
        }


        .weather-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex: 0.7; 
        }

        #weather-icon {
            width: auto;
            height: auto;
            max-width: 25vmin; 
            max-height: 25vmin;
            border-radius: 8px;
            padding: 1.5vmin;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1; 
            margin: 0; 
        }
        #weather-icon .material-symbols-outlined {
            font-size: 38vmin; 
            color: #ffffffff; 
        }

        .weather-details {
            flex: 1.3; 
            font-size: 3.8vmin;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            width: 100%; 
            position: relative; 
        }
        .weather-details > div:not(#temp-graph-container) { 
            margin-bottom: 0.5vmin;
        }
        .weather-details > div:last-child:not(#temp-graph-container) {
            margin-bottom: 0;
        }


        #temperature {
            font-size: 16vmin;
            font-weight: 700;
            color: #eeeeee;
            line-height: 1.1;
        }
        #weather-description {
            font-size: 3.0vmin;
            color: #cccccc;
            line-height: 1.3;
            padding: 0 1vmin;
        }
        #city-name {
            font-size: 2.3vmin;
            color: #bbbbbb;
            margin-top: 0.5vmin;
        }

        .message {
            font-size: 3.5vmin;
            color: #bbbbbb;
        }

        .hidden {
            display: none !important;
        }

        #temp-graph-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            align-items: center;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 1vmin 0; 
        }
        .graph-title {
            font-size: 2vmin;
            color: #eeeeee;
            margin-bottom: 0.1vmin; 
            text-align: center;
        }
        .svg-graph-wrapper { 
            width: 98%; 
            flex-grow: 1; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #temp-line-graph { 
        }
        .axis-label {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.8vmin; 
            fill: #cccccc;
        }
        .temp-value-label {
            font-family: 'Roboto Mono', monospace;
            font-size: 3.0vmin; 
            fill: #dddddd;
        }

    </style>
</head>
<body>
    <div class="aspect-ratio-wrapper">
        <div class="signage-container">
            <div class="content-area">
                <div class="time-section">
                    <div id="time" class="font-roboto-mono">--:--:--</div>
                    <div id="date-container"> 
                        <div id="date" class="font-noto">----年--月--日 (-)</div>
                        <div id="attribution-text" class="font-noto hidden"></div> 
                    </div>
                </div>
                <div class="weather-section">
                    <div class="weather-icon-container"> 
                        <div id="weather-icon">
                            <span class="material-symbols-outlined">help</span>
                        </div>
                    </div>
                    <div class="weather-details">
                        <div id="temperature" class="font-roboto-mono">--°C</div>
                        <div id="weather-description" class="font-noto">読み込み中...</div>
                        <div id="city-name" class="font-noto">川崎市</div>
                        <div id="temp-graph-container" class="hidden">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var latitude = 35.5300;
        var longitude = 139.7036;

        var timeElement = document.getElementById('time');
        var dateElement = document.getElementById('date');
        var attributionTextElement = document.getElementById('attribution-text'); 
        var weatherIconContainerElement = document.querySelector('.weather-icon-container');
        var weatherIconElement = document.getElementById('weather-icon');
        var temperatureElement = document.getElementById('temperature');
        var weatherDescriptionElement = document.getElementById('weather-description');
        var cityNameElement = document.getElementById('city-name');
        var tempGraphContainerElement = document.getElementById('temp-graph-container');

        var todayWeatherData = null;
        var tomorrowWeatherData = null;
        var weeklyMaxTemps = []; 
        var weeklyDates = []; 

        var newsHeadlines = []; 
        var dateNewsDisplayState = 0; // 0: 日付, 1-N: ニュース(Nは取得件数)
        var dateNewsToggleIntervalId = null; 
        var newsFetchIntervalId = null; 


        var displayState = 0; 
        var weatherIntervalId = null;
        var displayToggleIntervalId = null;

        function customPadStart(str, targetLength, padString) {
            str = String(str);
            targetLength = targetLength >> 0; 
            padString = String((typeof padString !== 'undefined' ? padString : ' '));
            if (str.length > targetLength) {
                return String(str);
            } else {
                targetLength = targetLength - str.length;
                if (targetLength > padString.length) {
                    padString += padString.repeat(targetLength / padString.length); 
                }
                return padString.slice(0, targetLength) + String(str);
            }
        }
        
        function updateDateOrNewsDisplay() {
            attributionTextElement.classList.add('hidden'); 

            if (dateNewsDisplayState === 0) { // 日付表示
                var now = new Date();
                var year = now.getFullYear();
                var month = customPadStart(now.getMonth() + 1, 2, '0');
                var day = customPadStart(now.getDate(), 2, '0');
                var dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][now.getDay()];
                dateElement.textContent = year + "年" + month + "月" + day + "日 (" + dayOfWeek + ")";
                dateElement.style.fontSize = "4.5vmin"; 
                dateElement.style.whiteSpace = "nowrap"; 
                attributionTextElement.textContent = "weather by Open-Meteo, News by Zenn"; // 出典をZennに変更
                attributionTextElement.classList.remove('hidden'); 
            } else if (dateNewsDisplayState > 0 && newsHeadlines.length >= dateNewsDisplayState) { // ニュース表示
                dateElement.textContent = newsHeadlines[dateNewsDisplayState - 1]; // 配列のインデックスに合わせる
                dateElement.style.fontSize = "3.5vmin"; 
                dateElement.style.whiteSpace = "normal"; 
            } else { // フォールバック (ニュースがない場合やインデックス不正など)
                var now = new Date();
                var year = now.getFullYear();
                var month = customPadStart(now.getMonth() + 1, 2, '0');
                var day = customPadStart(now.getDate(), 2, '0');
                var dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][now.getDay()];
                dateElement.textContent = year + "年" + month + "月" + day + "日 (" + dayOfWeek + ")";
                dateElement.style.fontSize = "4.5vmin";
                dateElement.style.whiteSpace = "nowrap";
                attributionTextElement.textContent = "weather by Open-Meteo, News by Zenn";
                attributionTextElement.classList.remove('hidden');
                
                // 予期せぬ表示状態になった場合は日付に戻す
                dateNewsDisplayState = 0; 
            }
        }


        function updateTime() { 
            var now = new Date();
            var hours = customPadStart(now.getHours(), 2, '0');
            var minutes = customPadStart(now.getMinutes(), 2, '0');
            var seconds = customPadStart(now.getSeconds(), 2, '0');
            timeElement.textContent = hours + ":" + minutes + ":" + seconds;
        }


        function fetchNews() {
            var rssUrl = "https://zenn.dev/topics/ai/feed"; // Zenn AIトピックRSS URLに変更
            var proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(rssUrl);
            console.log("ニュース取得試行中: " + proxyUrl); 

            fetch(proxyUrl, { cache: 'no-store' }) 
                .then(function(response) {
                    if (!response.ok) {
                        return response.text().then(function(text) {
                            console.error("RSS取得エラーレスポンス:", text);
                            throw new Error("RSS取得エラー: " + response.status + " - " + response.statusText);
                        });
                    }
                    return response.text();
                })
                .then(function(str) {
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(str, "text/xml");
                    var errorNode = xmlDoc.querySelector("parsererror"); 
                    if (errorNode) {
                        console.error("RSS解析エラー (parsererror):", errorNode.textContent);
                        throw new Error("RSS解析エラー");
                    }
                    var items = xmlDoc.getElementsByTagName("entry"); // Zennは<entry>
                    if (items.length === 0) { 
                        items = xmlDoc.getElementsByTagName("item"); // Fallback
                    }

                    var fetchedHeadlines = [];
                    // 取得できる全てのヘッドラインを格納 (最大件数はフィードによる)
                    for (var i = 0; i < items.length; i++) { 
                        var titleElement = items[i].getElementsByTagName("title")[0];
                        if (titleElement) {
                            fetchedHeadlines.push(titleElement.textContent);
                        }
                    }
                    newsHeadlines = fetchedHeadlines;
                    if (newsHeadlines.length === 0) {
                        console.warn("ニュースヘッドラインを取得できませんでした。");
                        if (dateNewsDisplayState > 0) { 
                             dateElement.textContent = "ニュースなし";
                             dateElement.style.fontSize = "3.5vmin";
                             dateElement.style.whiteSpace = "normal";
                             attributionTextElement.classList.add('hidden');
                        }
                    }
                    // ニュース取得後、表示状態がニュースであれば更新
                    if (dateNewsDisplayState > 0) { 
                        updateDateOrNewsDisplay();
                    }
                })
                .catch(function(error) {
                    console.error("ニュース取得または解析最終エラー:", error);
                    newsHeadlines = []; 
                    if (dateNewsDisplayState > 0) { 
                        dateElement.textContent = "ニュース取得エラー"; 
                        dateElement.style.fontSize = "3.5vmin";
                        dateElement.style.whiteSpace = "normal";
                        attributionTextElement.classList.add('hidden');
                    }
                });
        }


        function getWeatherInfoFromWMOCode(code) {
            var wmoMap = {
                0: { description: "快晴", icon: "sunny" }, 1: { description: "ほぼ快晴", icon: "partly_cloudy_day" },
                2: { description: "所により曇り", icon: "partly_cloudy_day" }, 3: { description: "曇り", icon: "cloud" },
                45: { description: "霧", icon: "foggy" }, 48: { description: "霧氷", icon: "ac_unit" },
                51: { description: "霧雨 (弱)", icon: "rainy_light" }, 53: { description: "霧雨", icon: "rainy_light" },
                55: { description: "霧雨 (強)", icon: "rainy_light" }, 56: { description: "着氷性の霧雨", icon: "sleet" },
                57: { description: "着氷性の霧雨", icon: "sleet" }, 61: { description: "雨 (弱)", icon: "rainy" },
                63: { description: "雨", icon: "rainy" }, 65: { description: "雨 (強)", icon: "rainy_heavy" },
                66: { description: "着氷性の雨", icon: "sleet" }, 67: { description: "着氷性の雨", icon: "sleet" },
                71: { description: "雪 (弱)", icon: "weather_snowy" }, 73: { description: "雪", icon: "weather_snowy" },
                75: { description: "雪 (強)", icon: "weather_snowy" }, 77: { description: "霧雪", icon: "grain" },
                80: { description: "にわか雨 (弱)", icon: "rainy_light" }, 81: { description: "にわか雨", icon: "rainy" },
                82: { description: "にわか雨 (強)", icon: "thunderstorm" }, 85: { description: "にわか雪 (弱)", icon: "weather_snowy" },
                86: { description: "にわか雪 (強)", icon: "weather_snowy" }, 95: { description: "雷雨", icon: "thunderstorm" },
                96: { description: "雷雨 (雹)", icon: "thunderstorm" }, 99: { description: "雷雨 (雹)", icon: "thunderstorm" },
            };
            return wmoMap[code] || { description: "コード:" + code, icon: "help" };
        }

        function renderTemperatureLineGraph(temps, dates) {
            tempGraphContainerElement.innerHTML = ''; 

            if (!temps || temps.length === 0) {
                tempGraphContainerElement.innerHTML = '<div class="message" style="text-align:center; width:100%;">比較できる気温データがありません</div>';
                return;
            }
            
            var graphTitle = document.createElement('div');
            graphTitle.className = 'graph-title';
            graphTitle.textContent = '週間最高気温';
            tempGraphContainerElement.appendChild(graphTitle);

            var svgWrapper = document.createElement('div');
            svgWrapper.className = 'svg-graph-wrapper';
            tempGraphContainerElement.appendChild(svgWrapper);

            var svgNS = "http://www.w3.org/2000/svg";
            var svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("id", "temp-line-graph");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svgWrapper.appendChild(svg);
            
            var svgWidth = svgWrapper.offsetWidth || 200; 
            var svgHeight = svgWrapper.offsetHeight || 100; 

            var margin = { top: 20, right: 20, bottom: 45, left: 35 }; 
            var graphWidth = svgWidth - margin.left - margin.right;
            var graphHeight = svgHeight - margin.top - margin.bottom;

            if (graphWidth <=0 || graphHeight <=0) {
                graphWidth = Math.max(100, svgWidth * 0.7);
                graphHeight = Math.max(50, svgHeight * 0.6);
            }
            
            svg.setAttribute("viewBox", "0 0 " + svgWidth + " " + svgHeight);

            var g = document.createElementNS(svgNS, "g");
            g.setAttribute("transform", "translate(" + margin.left + "," + margin.top + ")");
            svg.appendChild(g);

            var dataPoints = [];
            for (var i = 0; i < temps.length; i++) {
                if (temps[i] !== null) {
                    var label = "";
                    if (i === 0) label = "今日";
                    else if (i === 1) label = "明日";
                    else {
                        var dateObj = new Date(dates[i]);
                        label = (dateObj.getMonth() + 1) + "/" + dateObj.getDate();
                    }
                    dataPoints.push({ label: label, temp: temps[i], dayIndex: i });
                }
            }
            
            if (dataPoints.length === 0) { 
                svgWrapper.innerHTML = '<div class="message">データなし</div>';
                return;
            }

            var yMin = Infinity, yMax = -Infinity;
            dataPoints.forEach(function(p){
                yMin = Math.min(yMin, p.temp);
                yMax = Math.max(yMax, p.temp);
            });
            if (yMin === Infinity) { yMin = 0; yMax = 30;} 
            
            var yPadding = (yMax - yMin) * 0.15 || 5; 
            yMin = Math.floor(yMin - yPadding);
            yMax = Math.ceil(yMax + yPadding);
            if (yMin === yMax) { yMin -= 5; yMax += 5; }

            function scaleY(temp) {
                if (yMax === yMin) return graphHeight / 2;
                return graphHeight - ((temp - yMin) / (yMax - yMin)) * graphHeight;
            }
            function scaleX(dayIndex) {
                if (temps.length <= 1) return graphWidth / 2; 
                return (graphWidth / (temps.length -1 )) * dayIndex;
            }


            var yAxisLine = document.createElementNS(svgNS, "line");
            yAxisLine.setAttribute("x1", "0"); yAxisLine.setAttribute("y1", "0");
            yAxisLine.setAttribute("x2", "0"); yAxisLine.setAttribute("y2", graphHeight);
            yAxisLine.setAttribute("stroke", "#777"); yAxisLine.setAttribute("stroke-width", "1");
            g.appendChild(yAxisLine);

            var numYTicks = 3; 
            for (var i = 0; i <= numYTicks; i++) {
                var val = yMin + (i/numYTicks) * (yMax - yMin);
                if (i === numYTicks/2 && numYTicks % 2 === 0 && numYTicks > 1) continue; 
                var yLabel = document.createElementNS(svgNS, "text");
                yLabel.setAttribute("class", "axis-label");
                yLabel.setAttribute("x", -5);
                yLabel.setAttribute("y", scaleY(val));
                yLabel.setAttribute("dy", "0.35em");
                yLabel.setAttribute("text-anchor", "end");
                yLabel.textContent = Math.round(val) + "°";
                g.appendChild(yLabel);
            }
            
            var xAxisLine = document.createElementNS(svgNS, "line");
            xAxisLine.setAttribute("x1", "0"); xAxisLine.setAttribute("y1", graphHeight);
            xAxisLine.setAttribute("x2", graphWidth); xAxisLine.setAttribute("y2", graphHeight);
            xAxisLine.setAttribute("stroke", "#777"); xAxisLine.setAttribute("stroke-width", "1");
            g.appendChild(xAxisLine);

            var linePath = "";
            dataPoints.forEach(function(p, i) {
                var xPos = scaleX(p.dayIndex);
                var yPos = scaleY(p.temp);
                if (i === 0) {
                    linePath += "M" + xPos + "," + yPos;
                } else {
                    linePath += " L" + xPos + "," + yPos;
                }
            });

            if (linePath !== "") {
                var line = document.createElementNS(svgNS, "path");
                line.setAttribute("d", linePath);
                line.setAttribute("fill", "none");
                line.setAttribute("stroke", "#eeeeee");
                line.setAttribute("stroke-width", "3.5"); 
                line.setAttribute("stroke-linecap", "round");
                line.setAttribute("stroke-linejoin", "round");
                g.appendChild(line);
            }
            
            dataPoints.forEach(function(p) {
                var xPos = scaleX(p.dayIndex);
                var yPos = scaleY(p.temp);
                var circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("cx", xPos);
                circle.setAttribute("cy", yPos);
                circle.setAttribute("r", "3.5"); 
                circle.setAttribute("fill", "#eeeeee");
                circle.setAttribute("stroke", "#333333");
                circle.setAttribute("stroke-width", "1.5");
                g.appendChild(circle);

                var tempValLabel = document.createElementNS(svgNS, "text");
                tempValLabel.setAttribute("class", "temp-value-label");
                tempValLabel.setAttribute("x", xPos);
                tempValLabel.setAttribute("y", yPos - 8); 
                tempValLabel.setAttribute("text-anchor", "middle");
                tempValLabel.textContent = p.temp + "°";
                g.appendChild(tempValLabel);

                var xLabel = document.createElementNS(svgNS, "text");
                xLabel.setAttribute("class", "axis-label");
                xLabel.setAttribute("x", xPos);
                xLabel.setAttribute("y", graphHeight + 18); 
                xLabel.setAttribute("text-anchor", "middle");
                xLabel.textContent = p.label;
                g.appendChild(xLabel);
            });
        }


        function updateWeatherDisplay() {
            temperatureElement.classList.add('hidden');
            weatherDescriptionElement.classList.add('hidden');
            cityNameElement.classList.add('hidden');
            tempGraphContainerElement.classList.add('hidden');
            weatherIconContainerElement.classList.add('hidden'); 

            if (displayState === 0 && todayWeatherData) { 
                weatherIconContainerElement.classList.remove('hidden');
                temperatureElement.classList.remove('hidden');
                weatherDescriptionElement.classList.remove('hidden');
                cityNameElement.classList.remove('hidden');

                var weatherInfo = getWeatherInfoFromWMOCode(todayWeatherData.weathercode);
                weatherIconElement.innerHTML = '<span class="material-symbols-outlined">' + weatherInfo.icon + '</span>';
                temperatureElement.textContent = todayWeatherData.temperature + "°C";
                var desc = "今日: " + weatherInfo.description;
                if (todayWeatherData.max_temp !== null && todayWeatherData.min_temp !== null) {
                    desc += " (最高 " + todayWeatherData.max_temp + "°C / 最低 " + todayWeatherData.min_temp + "°C)";
                }
                weatherDescriptionElement.textContent = desc;
                weatherDescriptionElement.classList.remove('message');

            } else if (displayState === 1 && tomorrowWeatherData) { 
                weatherIconContainerElement.classList.remove('hidden');
                temperatureElement.classList.remove('hidden');
                weatherDescriptionElement.classList.remove('hidden');
                cityNameElement.classList.remove('hidden');

                var weatherInfo = getWeatherInfoFromWMOCode(tomorrowWeatherData.weathercode);
                weatherIconElement.innerHTML = '<span class="material-symbols-outlined">' + weatherInfo.icon + '</span>';
                temperatureElement.textContent = tomorrowWeatherData.max_temp !== null ? tomorrowWeatherData.max_temp + "°C" : '--°C';
                var desc = "明日: " + weatherInfo.description;
                if (tomorrowWeatherData.max_temp !== null && tomorrowWeatherData.min_temp !== null) {
                    desc += " (最高 " + tomorrowWeatherData.max_temp + "°C / 最低 " + tomorrowWeatherData.min_temp + "°C)";
                }
                weatherDescriptionElement.textContent = desc;
                weatherDescriptionElement.classList.remove('message');

            } else if (displayState === 2) { 
                tempGraphContainerElement.classList.remove('hidden');
                document.querySelector('.weather-details').style.flex = '2'; 
                weatherIconContainerElement.classList.add('hidden'); 

                if (weeklyMaxTemps.length > 0 && weeklyDates.length > 0) {
                    setTimeout(function() {
                        renderTemperatureLineGraph(weeklyMaxTemps, weeklyDates);
                    }, 0);
                } else {
                    tempGraphContainerElement.innerHTML = '<div class="message" style="text-align:center; width:100%;">週間気温データ取得中...</div>';
                }
                 weatherDescriptionElement.classList.add('message'); 
                 weatherDescriptionElement.textContent = ''; 

            } else { 
                weatherIconContainerElement.classList.remove('hidden'); 
                weatherIconElement.innerHTML = '<span class="material-symbols-outlined">help</span>';
                temperatureElement.textContent = '--°C';
                temperatureElement.classList.remove('hidden');
                weatherDescriptionElement.textContent = "読込中...";
                weatherDescriptionElement.classList.add('message');
                weatherDescriptionElement.classList.remove('hidden');
                cityNameElement.classList.remove('hidden');
            }
            if (displayState !== 2) { 
                 document.querySelector('.weather-details').style.flex = '1.3';
            }
            cityNameElement.textContent = '川崎市'; 
        }


        function fetchWeather() {
            var apiUrl = "https://api.open-meteo.com/v1/forecast?latitude=" + latitude + "&longitude=" + longitude + "&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia/Tokyo&forecast_days=7";

            fetch(apiUrl)
                .then(function(response) {
                    if (!response.ok) {
                        var errorText = "APIエラー: " + response.status + " " + response.statusText;
                        return response.text().then(function(text) {
                            try { var errorData = JSON.parse(text); if (errorData && errorData.reason) { errorText = "APIエラー: " + errorData.reason; }} catch (e) {}
                            throw new Error(errorText);
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.current_weather && data.daily && data.daily.time && data.daily.time.length >= 7) {
                        todayWeatherData = {
                            temperature: Math.round(data.current_weather.temperature),
                            weathercode: data.current_weather.weathercode,
                            max_temp: data.daily.temperature_2m_max[0] !== null ? Math.round(data.daily.temperature_2m_max[0]) : null,
                            min_temp: data.daily.temperature_2m_min[0] !== null ? Math.round(data.daily.temperature_2m_min[0]) : null,
                        };
                        tomorrowWeatherData = {
                            weathercode: data.daily.weathercode[1],
                            max_temp: data.daily.temperature_2m_max[1] !== null ? Math.round(data.daily.temperature_2m_max[1]) : null,
                            min_temp: data.daily.temperature_2m_min[1] !== null ? Math.round(data.daily.temperature_2m_min[1]) : null,
                        };
                        
                        weeklyMaxTemps = [];
                        weeklyDates = [];
                        for (var i = 0; i < 7; i++) {
                            weeklyMaxTemps.push(data.daily.temperature_2m_max[i] !== null ? Math.round(data.daily.temperature_2m_max[i]) : null);
                            weeklyDates.push(data.daily.time[i]); 
                        }


                        if (!displayToggleIntervalId) {
                            updateWeatherDisplay(); 
                            displayToggleIntervalId = setInterval(function() {
                                displayState = (displayState + 1) % 3; 
                                updateWeatherDisplay();
                            }, 10000); 
                        } else {
                            updateWeatherDisplay(); 
                        }
                    } else {
                        console.warn('APIデータ形式エラー:', JSON.stringify(data, null, 2));
                        todayWeatherData = null; tomorrowWeatherData = null; weeklyMaxTemps = []; weeklyDates = [];
                        displayState = 0; 
                        updateWeatherDisplay(); 
                        if (displayToggleIntervalId) { clearInterval(displayToggleIntervalId); displayToggleIntervalId = null; }
                    }
                })
                .catch(function(error) {
                    console.error('天気情報取得失敗:', error);
                    todayWeatherData = null; tomorrowWeatherData = null; weeklyMaxTemps = []; weeklyDates = [];
                    displayState = 0; 
                    updateWeatherDisplay(); 
                    if (displayToggleIntervalId) { clearInterval(displayToggleIntervalId); displayToggleIntervalId = null; }
                });
        }

        updateTime(); 
        updateDateOrNewsDisplay(); 
        fetchWeather(); 
        fetchNews(); 

        setInterval(updateTime, 1000); 

        if (dateNewsToggleIntervalId) clearInterval(dateNewsToggleIntervalId);
        dateNewsToggleIntervalId = setInterval(function() { 
            // ニュースの数 + 日付表示(1) で割った余りを計算
            var cycleLength = newsHeadlines.length > 0 ? newsHeadlines.length + 1 : 1;
            dateNewsDisplayState = (dateNewsDisplayState + 1) % cycleLength; 
            updateDateOrNewsDisplay();
        }, 10000); 


        if (weatherIntervalId) clearInterval(weatherIntervalId);
        weatherIntervalId = setInterval(fetchWeather, 15 * 60 * 1000); 

        if (newsFetchIntervalId) clearInterval(newsFetchIntervalId);
        newsFetchIntervalId = setInterval(fetchNews, 60 * 60 * 1000); 


        function maintainAspectRatio() {
            var wrapper = document.querySelector('.aspect-ratio-wrapper');
            var viewportWidth = window.innerWidth;
            var viewportHeight = window.innerHeight;
            var newWidth, newHeight;
            var targetWidth = viewportWidth * 0.95;
            var targetHeight = viewportHeight * 0.95;

            if (targetWidth / targetHeight > 16 / 9) {
                newHeight = targetHeight;
                newWidth = newHeight * 16 / 9;
            } else {
                newWidth = targetWidth;
                newHeight = newWidth * 9 / 16;
            }
            wrapper.style.width = newWidth + "px";
            wrapper.style.height = newHeight + "px";
        }

        window.onresize = maintainAspectRatio;
        maintainAspectRatio();
    </script>
</body>
</html>
